openapi: 3.0.3
info:
  title: Jobs Workflow API
  version: 1.0.0
servers:
  - url: /api
paths:
  /jobs:
    get:
      summary: List jobs for a budget
      parameters:
        - in: query
          name: budgetId
          required: true
          schema:
            type: string
        - in: query
          name: type
          required: false
          schema:
            type: string
            enum:
              - budget_sync
              - suggestions_generate
              - sync_and_suggest
              - suggestions_retry_payee
              - suggestions_apply
              - snapshot_create
              - snapshot_redownload
              - scheduled_sync_and_suggest
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [queued, running, succeeded, failed, canceled]
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Job list
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'
  /jobs/{jobId}:
    get:
      summary: Get a single job by ID
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  job:
                    $ref: '#/components/schemas/Job'
                  steps:
                    type: array
                    items:
                      $ref: '#/components/schemas/JobStep'
  /jobs/sync:
    post:
      summary: Create a sync job (legacy alias)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/suggestions:
    post:
      summary: Create a suggestions generation job (legacy alias)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/sync-and-generate:
    post:
      summary: Create a combined sync then generate job (legacy alias)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/JobRequest'
                - type: object
                  properties:
                    fullResync:
                      type: boolean
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/budget-sync:
    post:
      summary: Create a budget sync job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/suggestions-generate:
    post:
      summary: Create a suggestions generation job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/sync-and-suggest:
    post:
      summary: Create a combined sync then suggest job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/JobRequest'
                - type: object
                  properties:
                    fullResync:
                      type: boolean
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/suggestions-retry:
    post:
      summary: Create a retry suggestions job for a payee group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetrySuggestionsRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/suggestions-apply:
    post:
      summary: Create an apply approved suggestions job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplySuggestionsRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/snapshot-create:
    post:
      summary: Create a snapshot job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
  /jobs/snapshot-redownload:
    post:
      summary: Create a snapshot redownload job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
components:
  schemas:
    Job:
      type: object
      properties:
        id:
          type: string
        budgetId:
          type: string
        type:
          type: string
          enum:
            - budget_sync
            - suggestions_generate
            - sync_and_suggest
            - suggestions_retry_payee
            - suggestions_apply
            - snapshot_create
            - snapshot_redownload
            - scheduled_sync_and_suggest
        status:
          type: string
          enum: [queued, running, succeeded, failed, canceled]
        createdAt:
          type: string
          format: date-time
        startedAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        failureReason:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true
    JobStep:
      type: object
      properties:
        id:
          type: string
        jobId:
          type: string
        stepType:
          type: string
          enum: [sync, suggestions]
        status:
          type: string
          enum: [queued, running, succeeded, failed, canceled]
        position:
          type: integer
        startedAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        failureReason:
          type: string
          nullable: true
    JobRequest:
      type: object
      required: [budgetId]
      properties:
        budgetId:
          type: string
    RetrySuggestionsRequest:
      type: object
      required: [budgetId, suggestionId]
      properties:
        budgetId:
          type: string
        suggestionId:
          type: string
    ApplySuggestionsRequest:
      type: object
      required: [budgetId, suggestionIds]
      properties:
        budgetId:
          type: string
        suggestionIds:
          type: array
          items:
            type: string
    JobResponse:
      type: object
      properties:
        job:
          $ref: '#/components/schemas/Job'
        steps:
          type: array
          items:
            $ref: '#/components/schemas/JobStep'
